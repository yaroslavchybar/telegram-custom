# syntax=docker/dockerfile:1

# --- Builder ---
FROM node:20-alpine AS builder
WORKDIR /app

# Use corepack so we use the repo's pnpm version
RUN corepack enable

# Install deps first for better layer caching
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# Copy the rest and build
COPY . .
ENV NODE_ENV=production
RUN pnpm build

# --- Runtime ---
FROM nginx:stable-alpine3.20-slim

RUN apk update && apk upgrade --no-cache

# SPA fallback + caching rules
COPY ./.docker/nginx.conf /etc/nginx/conf.d/default.conf

# Copy built assets to Nginx web root
COPY --from=builder /app/dist /usr/share/nginx/html

EXPOSE 80
